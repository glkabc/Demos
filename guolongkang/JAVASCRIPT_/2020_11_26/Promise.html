<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/base.css">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <h2>Promise</h2>
        <ol>
            <li>创建promise时，它既不是成功也不是失败状态。这个状态叫作pending（待定）。</li>
            <li>当promise返回时，称为 resolved（已解决）</li>
            <ol>
                <li>一个成功resolved的promise称为fullfilled（实现）。它返回一个值，可以通过将.then()块链接到promise链的末尾来访问该值。 .then()块中的执行程序函数将包含promise的返回值。</li>
                <li>一个不成功resolved的promise被称为rejected（拒绝）了。它返回一个原因（reason），一条错误消息，说明为什么拒绝promise。可以通过将.catch()块链接到promise链的末尾来访问此原因。</li>
            </ol>
        </ol>

        <hr>

        <h2> 运行代码以响应多个Promises的实现</h2>
        <pre>Promise.all([a,b,c]).then(values => {})</pre>
    </div>

    <script>
        // let a = fetch(url1);
        // let b = fetch(url2);
        // let c = fetch(url3);

        // Promise.all([a, b, c]).then(values => {});

        function fetchAndDecode(url, type) {
            return fetch(url).then(response => {
                if(!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }else {
                    if (type === 'blob') {
                        return response.blob();
                    } else if (type === 'text') {
                        return response.text();
                    }
                }  
            })
            .catch(e => {
                console.log('There has been a problem with your fetch operation: ' + e.message);
            })
            .finally( () => {
                console.log(`fetch attempt for "${url}" finished.`);
            } );
        }

        let coffee = fetchAndDecode('https://mdn.github.io/learning-area/javascript/asynchronous/introducing/coffee.jpg', 'blob');
        let tea = fetchAndDecode('https://mdn.github.io/learning-area/javascript/asynchronous/introducing/coffee.jpg', 'blob');
        // let description = fetchAndDecode('https://mdn.github.io/learning-area/javascript/asynchronous/introducing/coffee.jpg', 'text');

        Promise.all([coffee,tea]).then( values => {
            console.log(values);
            let objectURL1 = URL.createObjectURL(values[0]);
            let objectURL2 = URL.createObjectURL(values[1]);
            // let descText = values[2];

            let image1 = document.createElement('img');
            let image2 = document.createElement('img');
            image1.src = objectURL1;
            image2.src = objectURL2;
            document.body.appendChild(image1);
            document.body.appendChild(image2);

            // let para = document.createElement('p');
            // para.textContent = descText;
            // document.body.appendChild(para);
        })

        // let timeoutPromise = new Promise((resolve, reject) => {
        //     setTimeout(() => {
        //         resolve("success");
        //     }, 2000)
        // });
        // timeoutPromise.then((message) => {
        //     console.log(message);
        // })

        function timeoutPromise(message, interval) {
            return new Promise((resolve, reject) => {
                if (message === '' || typeof message !== 'string') {
                    reject('Message is empty or not a string');
                } else if (interval < 0 || typeof interval !== 'number') {
                    reject('Interval is negative or not a number');
                } else {
                    setTimeout(() => {
                        resolve(message);   
                    }, interval);
                }
            });
        }

        timeoutPromise('hello',2000).then( response => {
            console.log(response);
        })
        .catch(e => {
            console.log('Error' + e);
        });
    </script>
</body>
</html>